var L=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var h=(r,t,e)=>(L(r,t,"read from private field"),e?e.call(r):t.get(r)),c=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},d=(r,t,e,s)=>(L(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e);var p=(r,t,e)=>(L(r,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const o of l.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=e(i);fetch(i.href,l)}})();var S,v;class g{constructor(t,e){c(this,S,void 0);c(this,v,void 0);d(this,S,t),d(this,v,e)}get row(){return h(this,S)}get column(){return h(this,v)}toString(){return`{row: ${this.row}, column: ${this.column}}`}equals(t){return t.row===this.row&&t.column===this.column}}S=new WeakMap,v=new WeakMap;var C;class M{constructor(t,e,s){c(this,C,void 0);this.rows=t,this.columns=e,d(this,C,s)}get cells(){return h(this,C)}getCellAt(t){let[e,s]=[t.row,t.column];return e>=0&&e<this.rows&&s>=0&&s<this.columns?this.cells.find(i=>i.row===e&&i.column===s):null}getNumberOfArmedCells(){return this.cells.filter(t=>t.hasMine()).length}getCoveredCells(){return this.cells.filter(t=>t.isCovered())}getMinedCells(){return this.cells.filter(t=>t.hasMine())}getFlaggedCells(){return this.cells.filter(t=>t.isFlagged())}getCoveredFlaggedCells(){return this.cells.filter(t=>t.isFlagged()&&t.isCovered())}toggleFlagAt(t){this.getCellAt(t).toggleFlag()}selectCellAt(t){let e=this.getCellAt(t);e&&!e.isFlagged()&&e.isCovered()?(e.uncover(),e.hasMine()||this.uncoverUnarmedNeighbours(e)):console.log(`no selected cell: row ${t.row}, column ${t.column}`)}uncoverCellAt(t){let e=this.getCellAt(t);return e.uncover(),e}uncoverUnarmedNeighbours(t){let e=[t],s=[t];for(;e.length>0;){let l=e.pop().location,o=this.getNeighboursOf(l).filter(n=>!n.hasMine()).filter(n=>n.isCovered());for(let n of o)s.includes(n)||(n.uncover(),n.value===0&&e.push(n),s.push(n))}}getNeighboursOf(t){let[e,s]=[t.row,t.column],i=[];for(let l of[-1,0,1])for(let o of[-1,0,1]){let n=e+parseInt(l),a=s+parseInt(o);0<=n<this.rows&&0<=a<this.columns&&!(e===n&&s===a)&&i.push(this.getCellAt(new g(n,a)))}return i.filter(l=>!!l)}logCells(t=!1){for(let e=0;e<this.rows;e++){let s=" ";for(let i=0;i<this.columns;i++){let l=this.getCellAt(new g(e,i));s+=" "+(t?l.value:l.isCovered()?"A":l.value)}console.log(s)}}}C=new WeakMap;const O=-1;var u;class b{constructor(t,e=0){c(this,u,void 0);d(this,u,t),this.value=e,this.flagged=!1,this.covered=!0}get row(){return h(this,u).row}get column(){return h(this,u).column}get location(){return h(this,u)}set location(t){d(this,u,t)}hasMine(){return this.value===O}setMine(){this.value=O}toggleFlag(){this.isCovered()&&(this.flagged=!this.flagged)}uncover(){this.covered=!1}isCovered(){return this.covered}isFlagged(){return this.flagged}}u=new WeakMap;class I{constructor(t){this.settings=t}get rows(){return this.settings.rows}get columns(){return this.settings.columns}get mines(){return this.settings.mines}prepare(){let t=this.prepareCells(),e=new M(this.rows,this.columns,t);return this.prepareMines(e),this.prepareNumbers(e),e}prepareCells(){let t=[];for(let e=0;e<this.rows;e++)for(let s=0;s<this.columns;s++)t.push(new b(new g(e,s),0));return t}getRandomLocation(){let t=Math.floor(Math.random()*this.rows),e=Math.floor(Math.random()*this.columns);return new g(t,e)}prepareMines(t){for(;t.getNumberOfArmedCells()<this.mines;)t.getCellAt(this.getRandomLocation()).setMine()}prepareNumbers(t){for(let e=0;e<this.rows;e++)for(let s=0;s<this.columns;s++){let i=new g(e,s),l=t.getCellAt(i);if(!l.hasMine()){let o=t.getNeighboursOf(i).filter(n=>n.hasMine());l.value=o.length}}}}var w,B;class _{constructor(t){c(this,w);this.settings=t,this.board=p(this,w,B).call(this)}get initialNumberOfMines(){return this.settings.mines}isGameFinished(){return this.isGameWon()||this.isGameLost()}isGameWon(){let t=this.board.getCoveredCells();return t.every(e=>e.hasMine())&&t.length===this.initialNumberOfMines}isGameLost(){return this.board.cells.filter(e=>!e.isCovered()&&e.hasMine()).length>0}toggleFlagAt(t){this.board.toggleFlagAt(t)}selectCellAt(t){this.board.selectCellAt(t)}uncoverAllCells(){for(let t of this.board.cells)t.isCovered()&&t.uncover()}get numberOfFlaggedCells(){return this.board.getCoveredFlaggedCells().length}}w=new WeakSet,B=function(){return new I(this.settings).prepare()};class k{constructor(t){this.ROWS=t.rows,this.COLUMNS=t.columns,this.BLOCK_SIZE=20,this.SPACE_BETWEEN=4,this.canvas=document.querySelector("#canvas"),this.ctx=this.canvas.getContext("2d"),this.trackedListeners=[],this.setCanvasSize(this.calculateRequiredCanvasLength(this.COLUMNS),this.calculateRequiredCanvasLength(this.ROWS)),this.saveSettingsButton=document.querySelector(".modal__save"),this.startGameButton=document.querySelector("#start-button"),this.flagButton=document.getElementById("flag-button"),this.minesCounterElement=document.getElementById("mines-counter"),this.settingsButton=document.querySelector(".settings-button"),this.modal=document.querySelector(".modal"),this.closeModalButton=document.querySelector(".modal__exit"),this.backdrop=document.querySelector(".backdrop"),this.rowsModalInput=document.querySelector("#input-rows"),this.columnsModalInput=document.querySelector("#input-columns"),this.minesModalInput=document.querySelector("#input-mines"),this.difficultiesElements=document.querySelectorAll(".modal__difficulty"),this.bindModalToggle()}bindModalToggle(){this.addTrackedEventListener(this.closeModalButton,"click",()=>{this.closeSettingsModal()}),this.addTrackedEventListener(this.backdrop,"click",()=>{this.closeSettingsModal()})}addTrackedEventListener(t,e,s){t.addEventListener(e,s),this.trackEventListener(t,e,s)}untrackAllEventListeners(){for(let{element:t,type:e,listener:s}of this.trackedListeners)t&&(t.removeEventListener(e,s,{capture:!0}),t.removeEventListener(e,s,{capture:!1}));this.trackedListeners=[]}trackEventListener(t,e,s){this.trackedListeners.push({element:t,type:e,listener:s})}setCanvasSize(t,e){this.canvas.width=t,this.canvas.height=e}get canvasLeft(){return this.canvas.offsetLeft+this.canvas.clientLeft-this.canvas.scrollLeft}get canvasTop(){return this.canvas.offsetTop+this.canvas.clientTop-this.canvas.scrollTop}calculateRequiredCanvasLength(t){return t*(this.BLOCK_SIZE+this.SPACE_BETWEEN)+this.SPACE_BETWEEN}setMinesCounter(t){let e=this.prepareStringToDisplayMinesCounter(t),s=[...this.minesCounterElement.childNodes].filter(i=>i.nodeName==="IMG");for(let i=0;i<s.length;i++){let l=s[i];if(l.src!=null){let n=`./assets/images/segment${e[i]}.png`;l.src=n}}}prepareStringToDisplayMinesCounter(t,e=3){let s=t<0,l=Math.abs(t).toString().padStart(e,"0");return s&&(l="-".concat(l.slice(1))),l}setFlagButtonOff(){this.flagButton.classList.remove("active")}setFlagButtonOn(){this.flagButton.classList.add("active")}alertOnGameWon(){alert("You win")}alertOnGameLost(){alert("You lost")}getLocationOfClick(t){function e(n,a,f){return f<=a&&n<=f}let s=t.pageX-this.canvasLeft,i=t.pageY-this.canvasTop,l=null,o=null;for(let n=0;n<this.COLUMNS;n++){let a=this.SPACE_BETWEEN+n*(this.SPACE_BETWEEN+this.BLOCK_SIZE),f=(n+1)*(this.SPACE_BETWEEN+this.BLOCK_SIZE);if(e(a,f,s)){l=n;break}}for(let n=0;n<this.ROWS;n++){let a=this.SPACE_BETWEEN+n*(this.SPACE_BETWEEN+this.BLOCK_SIZE),f=(n+1)*(this.SPACE_BETWEEN+this.BLOCK_SIZE);if(e(a,f,i)){o=n;break}}return o!==null&&l!==null?new g(o,l):null}displayBoard(t,e){if(this.canvas.getContext){this.ctx.fillStyle="gray",this.ctx.strokeStyle="black";for(let s=0;s<t.rows;s++)for(let i=0;i<t.columns;i++){let l=this.SPACE_BETWEEN+i*(this.BLOCK_SIZE+this.SPACE_BETWEEN),o=this.SPACE_BETWEEN+s*(this.BLOCK_SIZE+this.SPACE_BETWEEN);e&&e.equals(new g(s,i))?this.drawExplodedMine(l,o):this.drawCell(l,o,t.getCellAt(new g(s,i)))}}}drawCell(t,e,s){this.ctx.fillStyle=s.isCovered()?"gray":"lightgray",this.ctx.strokeStyle="black",this.ctx.fillRect(t,e,this.BLOCK_SIZE,this.BLOCK_SIZE),this.ctx.strokeRect(t,e,this.BLOCK_SIZE,this.BLOCK_SIZE),s&&(s.isCovered()&&s.isFlagged()?this.drawFlag(t,e):s.isCovered()||(s.hasMine()&&s.isFlagged()?this.drawFlaggedMine(t,e):s.hasMine()?this.drawMine(t,e):s.value>0&&this.drawNumberInside(t,e,s.value.toString())))}drawFlag(t,e){try{this.ctx.fillStyle="red",this.ctx.fillRect(t+.2*this.BLOCK_SIZE,e+.2*this.BLOCK_SIZE,.4*this.BLOCK_SIZE,.3*this.BLOCK_SIZE),this.ctx.lineWidth=2,this.ctx.fillStyle="black",this.ctx.beginPath(),this.ctx.moveTo(t+.55*this.BLOCK_SIZE,e+.2*this.BLOCK_SIZE),this.ctx.lineTo(t+.55*this.BLOCK_SIZE,e+.8*this.BLOCK_SIZE),this.ctx.stroke(),this.ctx.fillStyle="black",this.ctx.beginPath(),this.ctx.moveTo(t+.2*this.BLOCK_SIZE,e+.8*this.BLOCK_SIZE),this.ctx.lineTo(t+.8*this.BLOCK_SIZE,e+.8*this.BLOCK_SIZE),this.ctx.stroke(),this.ctx.lineWidth=1}catch(s){console.log(s)}}drawNumberInside(t,e,s){this.ctx.fillText(s,t+.4*this.BLOCK_SIZE,e+.6*this.BLOCK_SIZE),this.ctx.strokeText(s,t+.4*this.BLOCK_SIZE,e+.6*this.BLOCK_SIZE)}drawMine(t,e){try{this.ctx.fillStyle="black";const s=new Path2D;s.arc(t+this.BLOCK_SIZE/2,e+this.BLOCK_SIZE/2,.3*this.BLOCK_SIZE,0,2*Math.PI),this.ctx.fill(s),this.ctx.beginPath(),this.ctx.moveTo(t+this.BLOCK_SIZE/2,e+.1*this.BLOCK_SIZE),this.ctx.lineTo(t+this.BLOCK_SIZE/2,e+.9*this.BLOCK_SIZE),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+.1*this.BLOCK_SIZE,e+this.BLOCK_SIZE/2),this.ctx.lineTo(t+.9*this.BLOCK_SIZE,e+this.BLOCK_SIZE/2),this.ctx.stroke(),this.ctx.fillStyle="white";const i=new Path2D;i.arc(t+.4*this.BLOCK_SIZE,e+.4*this.BLOCK_SIZE,.075*this.BLOCK_SIZE,0,2*Math.PI),this.ctx.fill(i)}catch(s){console.log(s)}}drawExplodedMine(t,e){try{this.ctx.fillStyle="red",this.ctx.fillRect(t,e,this.BLOCK_SIZE,this.BLOCK_SIZE),this.drawMine(t,e)}catch(s){console.log(s)}}drawFlaggedMine(t,e){try{this.drawMine(t,e),this.ctx.strokeStyle="red",this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+this.BLOCK_SIZE,e+this.BLOCK_SIZE),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+this.BLOCK_SIZE,e),this.ctx.lineTo(t,e+this.BLOCK_SIZE),this.ctx.stroke()}catch(s){console.log(s)}}openSettingsModal(){this.modal.classList.add("open"),this.backdrop.classList.add("open")}getSettingsModalValues(){let t=this.rowsModalInput.value,e=this.columnsModalInput.value,s=this.minesModalInput.value;return{rows:parseInt(t),columns:parseInt(e),mines:parseInt(s)}}setSettingsModalValues(t,e,s){this.rowsModalInput.value=t,this.columnsModalInput.value=e,this.minesModalInput.value=s}closeSettingsModal(){this.modal&&(this.modal.classList.remove("open"),this.backdrop.classList.remove("open"))}bindToggleFlagMode(t){this.addTrackedEventListener(this.flagButton,"click",t)}bindStartGame(t){this.addTrackedEventListener(this.startGameButton,"click",t)}bindSaveSettings(t){this.addTrackedEventListener(this.saveSettingsButton,"click",e=>{let s=this.getSettingsModalValues();t(s),this.closeSettingsModal()})}bindUncoverAt(t){let e=s=>{s.preventDefault(),t(this.getLocationOfClick(s))};this.addTrackedEventListener(this.canvas,"click",e)}bindToggleFlagAt(t){let e=s=>{s.preventDefault(),t(this.getLocationOfClick(s))};this.addTrackedEventListener(this.canvas,"contextmenu",e)}bindSettingsButtonClicked(t){this.addTrackedEventListener(this.settingsButton,"click",t)}bindDifficultyLevelElementClicked(t){for(let e of this.difficultiesElements)this.addTrackedEventListener(e,"click",()=>{t(e.textContent)})}}var E,m;class T{constructor(){c(this,E,void 0);c(this,m,void 0);d(this,m,{EASY:{rows:8,columns:8,mines:10},MEDIUM:{rows:16,columns:16,mines:40},HARD:{rows:30,columns:16,mines:99}}),d(this,E,h(this,m).EASY)}set settings(t){this.validateSettings(t)&&localStorage.setItem("settings",JSON.stringify(t))}get settings(){let t=h(this,E),e=JSON.parse(localStorage.getItem("settings"));return e&&this.validateSettings(e)&&(t=e),JSON.parse(JSON.stringify(t))}get levelSettings(){return JSON.parse(JSON.stringify(h(this,m)))}validateSettings(t){return t.rows>0&&t.columns>0&&t.mines>=0&&t.rows*t.columns>=t.mines}}E=new WeakMap,m=new WeakMap;class A{constructor(){this.model=null,this.view=null,this.settingsController=new T,this.flagMode=!1}bindView(t){this.view&&(this.view.untrackAllEventListeners(),delete this.view),this.view=t,this.view.bindToggleFlagAt(this.handleToggleFlagAt.bind(this)),this.view.bindUncoverAt(this.handleUncoverAt.bind(this)),this.view.bindToggleFlagMode(this.handleToggleFlagMode.bind(this)),this.view.bindStartGame(this.handleStartGame.bind(this)),this.view.bindSaveSettings(this.handleSaveSettings.bind(this)),this.view.bindSettingsButtonClicked(this.handleSettingsButtonClick.bind(this)),this.view.bindDifficultyLevelElementClicked(this.handleDifficultyLevelClick.bind(this))}bindModel(t){this.model=t}get levelSettings(){return this.settingsController.levelSettings}getSettings(){return this.settingsController.settings}rerenderView(){this.view.displayBoard(this.model.board),this.view.setMinesCounter(this.model.initialNumberOfMines-this.model.numberOfFlaggedCells)}handleLocationSelected(t,e){t&&(this.model.isGameFinished()||(e?this.model.toggleFlagAt(t):this.model.selectCellAt(t),this.rerenderView(),this.model.isGameWon()?this.handleGameWon():this.model.isGameLost()&&this.handleGameLost(t)))}handleUncoverAt(t){this.handleLocationSelected(t,this.flagMode)}handleToggleFlagAt(t){this.handleLocationSelected(t,!0)}handleGameLost(t){this.model.uncoverAllCells(),this.view.alertOnGameLost(),this.view.displayBoard(this.model.board,t)}handleGameWon(){this.view.alertOnGameWon()}handleToggleFlagMode(){this.flagMode?this.setFlagModeOff():this.setFlagModeOn()}setFlagModeOff(){this.flagMode=!1,this.view.setFlagButtonOff()}setFlagModeOn(){this.flagMode=!0,this.view.setFlagButtonOn()}handleStartGame(){let t=this.getSettings();this.bindModel(new _(t)),this.bindView(new k(t)),this.setFlagModeOff(),this.rerenderView()}handleSaveSettings(t){this.settingsController.settings=t,this.handleStartGame()}handleSettingsButtonClick(){this.view.openSettingsModal();let t=this.getSettings();this.view.setSettingsModalValues(t.rows,t.columns,t.mines)}handleDifficultyLevelClick(t){t in this.levelSettings&&this.view.setSettingsModalValues(this.levelSettings[t].rows,this.levelSettings[t].columns,this.levelSettings[t].mines)}}let K=new A;K.handleStartGame();
