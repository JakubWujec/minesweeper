var L=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var a=(r,e,t)=>(L(r,e,"read from private field"),t?t.call(r):e.get(r)),c=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},d=(r,e,t,s)=>(L(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t);var M=(r,e,t)=>(L(r,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const o of l.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=t(i);fetch(i.href,l)}})();var v,S;class g{constructor(e,t){c(this,v,void 0);c(this,S,void 0);d(this,v,e),d(this,S,t)}get row(){return a(this,v)}get column(){return a(this,S)}toString(){return`{row: ${this.row}, column: ${this.column}}`}equals(e){return e.row===this.row&&e.column===this.column}}v=new WeakMap,S=new WeakMap;var C;class k{constructor(e,t,s){c(this,C,void 0);this.rows=e,this.columns=t,d(this,C,s)}get cells(){return a(this,C)}getCellAt(e){let[t,s]=[e.row,e.column];return t>=0&&t<this.rows&&s>=0&&s<this.columns?this.cells.find(i=>i.row===t&&i.column===s):null}getNumberOfArmedCells(){return this.cells.filter(e=>e.hasMine()).length}getCoveredCells(){return this.cells.filter(e=>e.isCovered())}getMinedCells(){return this.cells.filter(e=>e.hasMine())}getFlaggedCells(){return this.cells.filter(e=>e.isFlagged())}getCoveredFlaggedCells(){return this.cells.filter(e=>e.isFlagged()&&e.isCovered())}toggleFlagAt(e){this.getCellAt(e).toggleFlag()}selectCellAt(e){let t=this.getCellAt(e);t&&!t.isFlagged()&&t.isCovered()?(t.uncover(),t.hasMine()||this.uncoverUnarmedNeighbours(t)):console.log(`no selected cell: row ${e.row}, column ${e.column}`)}uncoverCellAt(e){let t=this.getCellAt(e);return t.uncover(),t}uncoverUnarmedNeighbours(e){let t=[e],s=[e];for(;t.length>0;){let l=t.pop().location,o=this.getNeighboursOf(l).filter(n=>!n.hasMine()).filter(n=>n.isCovered());for(let n of o)s.includes(n)||(n.uncover(),n.value===0&&t.push(n),s.push(n))}}getNeighboursOf(e){let[t,s]=[e.row,e.column],i=[];for(let l of[-1,0,1])for(let o of[-1,0,1]){let n=t+parseInt(l),h=s+parseInt(o);0<=n<this.rows&&0<=h<this.columns&&!(t===n&&s===h)&&i.push(this.getCellAt(new g(n,h)))}return i.filter(l=>!!l)}logCells(e=!1){for(let t=0;t<this.rows;t++){let s=" ";for(let i=0;i<this.columns;i++){let l=this.getCellAt(new g(t,i));s+=" "+(e?l.value:l.isCovered()?"A":l.value)}console.log(s)}}}C=new WeakMap;const O=-1;var u;class A{constructor(e,t=0){c(this,u,void 0);d(this,u,e),this.value=t,this.flagged=!1,this.covered=!0}get row(){return a(this,u).row}get column(){return a(this,u).column}get location(){return a(this,u)}set location(e){d(this,u,e)}hasMine(){return this.value===O}setMine(){this.value=O}toggleFlag(){this.isCovered()&&(this.flagged=!this.flagged)}uncover(){this.covered=!1}isCovered(){return this.covered}isFlagged(){return this.flagged}}u=new WeakMap;class T{constructor(e){this.settings=e}get rows(){return this.settings.rows}get columns(){return this.settings.columns}get mines(){return this.settings.mines}prepare(){let e=this.prepareCells(),t=new k(this.rows,this.columns,e);return this.prepareMines(t),this.prepareNumbers(t),t}prepareCells(){let e=[];for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)e.push(new A(new g(t,s),0));return e}getRandomLocation(){let e=Math.floor(Math.random()*this.rows),t=Math.floor(Math.random()*this.columns);return new g(e,t)}prepareMines(e){for(;e.getNumberOfArmedCells()<this.mines;)e.getCellAt(this.getRandomLocation()).setMine()}prepareNumbers(e){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++){let i=new g(t,s),l=e.getCellAt(i);if(!l.hasMine()){let o=e.getNeighboursOf(i).filter(n=>n.hasMine());l.value=o.length}}}}var w,b;class B{constructor(e){c(this,w);this.settings=e,this.board=M(this,w,b).call(this)}get initialNumberOfMines(){return this.settings.mines}isGameFinished(){return this.isGameWon()||this.isGameLost()}isGameWon(){let e=this.board.getCoveredCells();return e.every(t=>t.hasMine())&&e.length===this.initialNumberOfMines}isGameLost(){return this.board.cells.filter(t=>!t.isCovered()&&t.hasMine()).length>0}toggleFlagAt(e){this.board.toggleFlagAt(e)}selectCellAt(e){this.board.selectCellAt(e)}uncoverAllCells(){for(let e of this.board.cells)e.isCovered()&&e.uncover()}get numberOfFlaggedCells(){return this.board.getCoveredFlaggedCells().length}}w=new WeakSet,b=function(){return new T(this.settings).prepare()};class I{constructor(e){this.ROWS=e.rows,this.COLUMNS=e.columns,this.BLOCK_SIZE=20,this.SPACE_BETWEEN=4,this.canvas=document.querySelector("#canvas"),this.ctx=this.canvas.getContext("2d"),this.trackedListeners=[],this.setCanvasSize(this.calculateRequiredCanvasLength(this.COLUMNS),this.calculateRequiredCanvasLength(this.ROWS)),this.saveSettingsButton=document.querySelector(".modal__save"),this.startGameButton=document.querySelector(".start-button"),this.flagButton=document.getElementById("flag-button"),this.minesCounterElement=document.getElementById("mines-counter"),this.settingsButton=document.querySelector(".settings-button"),this.modal=document.querySelector(".modal"),this.closeModalButton=document.querySelector(".modal__exit"),this.backdrop=document.querySelector(".backdrop"),this.rowsModalInput=document.querySelector("#input-rows"),this.columnsModalInput=document.querySelector("#input-columns"),this.minesModalInput=document.querySelector("#input-mines"),this.difficultiesElements=document.querySelectorAll(".modal__difficulty"),this.bindModalToggle()}bindModalToggle(){this.addTrackedEventListener(this.closeModalButton,"click",()=>{this.closeSettingsModal()}),this.addTrackedEventListener(this.backdrop,"click",()=>{this.closeSettingsModal()})}addTrackedEventListener(e,t,s){e.addEventListener(t,s),this.trackEventListener(e,t,s)}untrackAllEventListeners(){for(let{element:e,type:t,listener:s}of this.trackedListeners)e&&(e.removeEventListener(t,s,{capture:!0}),e.removeEventListener(t,s,{capture:!1}));this.trackedListeners=[]}trackEventListener(e,t,s){this.trackedListeners.push({element:e,type:t,listener:s})}setCanvasSize(e,t){this.canvas.width=e,this.canvas.height=t}get canvasLeft(){return this.canvas.offsetLeft+this.canvas.clientLeft-this.canvas.scrollLeft}get canvasTop(){return this.canvas.offsetTop+this.canvas.clientTop-this.canvas.scrollTop}calculateRequiredCanvasLength(e){return e*(this.BLOCK_SIZE+this.SPACE_BETWEEN)+this.SPACE_BETWEEN}setMinesCounter(e,t){this.minesCounterElement.innerText=`Mines ${e} / ${t}`}setFlagButtonOff(){this.flagButton.classList.remove("active")}setFlagButtonOn(){this.flagButton.classList.add("active")}alertOnGameWon(){alert("You win")}alertOnGameLost(){alert("You lost")}getLocationOfClick(e){function t(n,h,f){return f<=h&&n<=f}let s=e.pageX-this.canvasLeft,i=e.pageY-this.canvasTop,l=null,o=null;for(let n=0;n<this.COLUMNS;n++){let h=this.SPACE_BETWEEN+n*(this.SPACE_BETWEEN+this.BLOCK_SIZE),f=(n+1)*(this.SPACE_BETWEEN+this.BLOCK_SIZE);if(t(h,f,s)){l=n;break}}for(let n=0;n<this.ROWS;n++){let h=this.SPACE_BETWEEN+n*(this.SPACE_BETWEEN+this.BLOCK_SIZE),f=(n+1)*(this.SPACE_BETWEEN+this.BLOCK_SIZE);if(t(h,f,i)){o=n;break}}return o!==null&&l!==null?new g(o,l):null}displayBoard(e,t){if(this.canvas.getContext){this.ctx.fillStyle="gray",this.ctx.strokeStyle="black";for(let s=0;s<e.rows;s++)for(let i=0;i<e.columns;i++){let l=this.SPACE_BETWEEN+i*(this.BLOCK_SIZE+this.SPACE_BETWEEN),o=this.SPACE_BETWEEN+s*(this.BLOCK_SIZE+this.SPACE_BETWEEN);t&&t.equals(new g(s,i))?this.drawExplodedMine(l,o):this.drawCell(l,o,e.getCellAt(new g(s,i)))}}}drawCell(e,t,s){this.ctx.fillStyle=s.isCovered()?"gray":"lightgray",this.ctx.strokeStyle="black",this.ctx.fillRect(e,t,this.BLOCK_SIZE,this.BLOCK_SIZE),this.ctx.strokeRect(e,t,this.BLOCK_SIZE,this.BLOCK_SIZE),s&&(s.isCovered()&&s.isFlagged()?this.drawFlag(e,t):s.isCovered()||(s.hasMine()&&s.isFlagged()?this.drawFlaggedMine(e,t):s.hasMine()?this.drawMine(e,t):s.value>0&&this.drawNumberInside(e,t,s.value.toString())))}drawFlag(e,t){try{let s=new Image;s.src="./assets/images/flag1.png",this.ctx.drawImage(s,e+.1*this.BLOCK_SIZE,t+.1*this.BLOCK_SIZE,.8*this.BLOCK_SIZE,.8*this.BLOCK_SIZE)}catch(s){console.log(s)}}drawNumberInside(e,t,s){this.ctx.fillText(s,e+.4*this.BLOCK_SIZE,t+.6*this.BLOCK_SIZE),this.ctx.strokeText(s,e+.4*this.BLOCK_SIZE,t+.6*this.BLOCK_SIZE)}drawMine(e,t){try{this.ctx.fillStyle="black";const s=new Path2D;s.arc(e+this.BLOCK_SIZE/2,t+this.BLOCK_SIZE/2,.3*this.BLOCK_SIZE,0,2*Math.PI),this.ctx.fill(s),this.ctx.beginPath(),this.ctx.moveTo(e+this.BLOCK_SIZE/2,t+.1*this.BLOCK_SIZE),this.ctx.lineTo(e+this.BLOCK_SIZE/2,t+.9*this.BLOCK_SIZE),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+.1*this.BLOCK_SIZE,t+this.BLOCK_SIZE/2),this.ctx.lineTo(e+.9*this.BLOCK_SIZE,t+this.BLOCK_SIZE/2),this.ctx.stroke(),this.ctx.fillStyle="white";const i=new Path2D;i.arc(e+.4*this.BLOCK_SIZE,t+.4*this.BLOCK_SIZE,.075*this.BLOCK_SIZE,0,2*Math.PI),this.ctx.fill(i)}catch(s){console.log(s)}}drawExplodedMine(e,t){try{this.ctx.fillStyle="red",this.ctx.fillRect(e,t,this.BLOCK_SIZE,this.BLOCK_SIZE),this.drawMine(e,t)}catch(s){console.log(s)}}drawFlaggedMine(e,t){try{this.drawMine(e,t),this.ctx.strokeStyle="red",this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(e+this.BLOCK_SIZE,t+this.BLOCK_SIZE),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e+this.BLOCK_SIZE,t),this.ctx.lineTo(e,t+this.BLOCK_SIZE),this.ctx.stroke()}catch(s){console.log(s)}}openSettingsModal(){this.modal.classList.add("open"),this.backdrop.classList.add("open")}getSettingsModalValues(){let e=this.rowsModalInput.value,t=this.columnsModalInput.value,s=this.minesModalInput.value;return{rows:parseInt(e),columns:parseInt(t),mines:parseInt(s)}}setSettingsModalValues(e,t,s){this.rowsModalInput.value=e,this.columnsModalInput.value=t,this.minesModalInput.value=s}closeSettingsModal(){this.modal&&(this.modal.classList.remove("open"),this.backdrop.classList.remove("open"))}bindToggleFlagMode(e){this.addTrackedEventListener(this.flagButton,"click",e)}bindStartGame(e){this.addTrackedEventListener(this.startGameButton,"click",e)}bindSaveSettings(e){this.addTrackedEventListener(this.saveSettingsButton,"click",t=>{let s=this.getSettingsModalValues();e(s),this.closeSettingsModal()})}bindUncoverAt(e){let t=s=>{s.preventDefault(),e(this.getLocationOfClick(s))};this.addTrackedEventListener(this.canvas,"click",t)}bindToggleFlagAt(e){let t=s=>{s.preventDefault(),e(this.getLocationOfClick(s))};this.addTrackedEventListener(this.canvas,"contextmenu",t)}bindSettingsButtonClicked(e){this.addTrackedEventListener(this.settingsButton,"click",e)}bindDifficultyLevelElementClicked(e){for(let t of this.difficultiesElements)this.addTrackedEventListener(t,"click",()=>{e(t.textContent)})}}var E,m;class F{constructor(){c(this,E,void 0);c(this,m,void 0);d(this,m,{EASY:{rows:8,columns:8,mines:10},MEDIUM:{rows:16,columns:16,mines:40},HARD:{rows:30,columns:16,mines:99}}),d(this,E,a(this,m).EASY)}set settings(e){this.validateSettings(e)&&localStorage.setItem("settings",JSON.stringify(e))}get settings(){let e=a(this,E),t=JSON.parse(localStorage.getItem("settings"));return t&&this.validateSettings(t)&&(e=t),JSON.parse(JSON.stringify(e))}get levelSettings(){return JSON.parse(JSON.stringify(a(this,m)))}validateSettings(e){return e.rows>0&&e.columns>0&&e.mines>=0&&e.rows*e.columns>=e.mines}}E=new WeakMap,m=new WeakMap;class K{constructor(){this.model=null,this.view=null,this.settingsController=new F,this.flagMode=!1}bindView(e){this.view&&(this.view.untrackAllEventListeners(),delete this.view),this.view=e,this.view.bindToggleFlagAt(this.handleToggleFlagAt.bind(this)),this.view.bindUncoverAt(this.handleUncoverAt.bind(this)),this.view.bindToggleFlagMode(this.handleToggleFlagMode.bind(this)),this.view.bindStartGame(this.handleStartGame.bind(this)),this.view.bindSaveSettings(this.handleSaveSettings.bind(this)),this.view.bindSettingsButtonClicked(this.handleSettingsButtonClick.bind(this)),this.view.bindDifficultyLevelElementClicked(this.handleDifficultyLevelClick.bind(this))}bindModel(e){this.model=e}get levelSettings(){return this.settingsController.levelSettings}getSettings(){return this.settingsController.settings}rerenderView(){this.view.displayBoard(this.model.board),this.view.setMinesCounter(this.model.numberOfFlaggedCells,this.model.initialNumberOfMines)}handleLocationSelected(e,t){e&&(this.model.isGameFinished()||(t?this.model.toggleFlagAt(e):this.model.selectCellAt(e),this.rerenderView(),this.model.isGameWon()?this.handleGameWon():this.model.isGameLost()&&this.handleGameLost(e)))}handleUncoverAt(e){this.handleLocationSelected(e,this.flagMode)}handleToggleFlagAt(e){this.handleLocationSelected(e,!0)}handleGameLost(e){this.model.uncoverAllCells(),this.view.alertOnGameLost(),this.view.displayBoard(this.model.board,e)}handleGameWon(){this.view.alertOnGameWon()}handleToggleFlagMode(){this.flagMode?this.setFlagModeOff():this.setFlagModeOn()}setFlagModeOff(){this.flagMode=!1,this.view.setFlagButtonOff()}setFlagModeOn(){this.flagMode=!0,this.view.setFlagButtonOn()}handleStartGame(){let e=this.getSettings();this.bindModel(new B(e)),this.bindView(new I(e)),this.setFlagModeOff(),this.rerenderView()}handleSaveSettings(e){this.settingsController.settings=e,this.handleStartGame()}handleSettingsButtonClick(){this.view.openSettingsModal();let e=this.getSettings();this.view.setSettingsModalValues(e.rows,e.columns,e.mines)}handleDifficultyLevelClick(e){e in this.levelSettings&&this.view.setSettingsModalValues(this.levelSettings[e].rows,this.levelSettings[e].columns,this.levelSettings[e].mines)}}let p=new K,_={rows:8,columns:8,mines:10};p.bindModel(new B(_));p.bindView(new I(_));p.handleStartGame();
